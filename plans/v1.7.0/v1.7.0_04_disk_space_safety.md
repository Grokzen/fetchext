# Plan: Disk Space Safety

## Objective

Check free disk space before starting download or extraction to prevent partial writes and corruption.

## Requirements

1. Check available disk space in the target directory before downloading.
2. Check available disk space before extracting.
3. Raise `InsufficientDiskSpaceError` if space is low.
4. Add a safety buffer (e.g., 10MB or 10% of file size).

## Implementation Steps

### 1. Utils (`src/fetchext/utils.py`)

* Add `check_disk_space(path: Path, required_bytes: int)` function.
* Use `shutil.disk_usage(path)`.

### 2. Exceptions (`src/fetchext/exceptions.py`)

* Add `InsufficientDiskSpaceError`.

### 3. Core (`src/fetchext/core.py`)

* In `download_extension`:
  * Estimate file size (if possible via HEAD request, otherwise assume a safe default or skip check until headers are received).
  * Actually, `download_file` in `network.py` is where the download happens.
* In `extract_extension`:
  * Calculate required space (sum of uncompressed size of all files in archive).
  * Call `check_disk_space`.

### 4. Network (`src/fetchext/network.py`)

* In `download_file`:
  * Get `Content-Length` from headers.
  * Call `check_disk_space` before starting the stream.

## Verification

* Unit test: Mock `shutil.disk_usage` to simulate low disk space.
* Integration test: N/A (hard to simulate real disk full).
