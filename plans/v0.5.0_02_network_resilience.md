# Plan: Network Resilience (v0.5.0)

## Goal

Add retry logic with backoff for network requests to handle transient failures.

## Current State

Downloaders use `requests.get` directly. If a request fails (connection error, 5xx), it raises an exception immediately.

## Implementation Strategy

Use `requests.adapters.HTTPAdapter` with `urllib3.util.retry.Retry`. This avoids adding `tenacity` as a dependency, keeping the project lightweight.

## Specification

- **Retries**: 3 times.
- **Backoff Factor**: 1 (sleep 1s, 2s, 4s).
- **Status Codes**: 500, 502, 503, 504.
- **Methods**: GET.

## Implementation Plan

1. **Create `src/fetchext/network.py`**:
    - Function `get_session() -> requests.Session`:
        - Create `requests.Session`.
        - Create `Retry` object with specified config.
        - Mount `HTTPAdapter` to `https://` and `http://`.
        - Return session.

2. **Update Downloaders**:
    - `src/fetchext/downloaders/chrome.py`
    - `src/fetchext/downloaders/edge.py`
    - `src/fetchext/downloaders/firefox.py`
    - Replace `requests.get` with `session = get_session(); session.get(...)`.
    - Or better, instantiate the session in `__init__` of `BaseDownloader`?
    - `BaseDownloader` is an ABC. We can add a concrete method `_get_session()` or just use the helper.
    - Since `download` is the main method, creating a session there is fine. Or use a context manager `with get_session() as session:`.

3. **Testing**:
    - Create `tests/unit/test_network.py`.
    - Mock `requests.Session.mount` or use `responses` / `requests_mock` to simulate failures and verify retries.
    - Since we use `pytest-mock`, we can mock `urllib3` or just verify the adapter configuration.
    - Integration tests with `pyfakefs` don't hit network, but we can mock the network layer to fail N times then succeed.

## Files to Modify

- `src/fetchext/network.py` (New)
- `src/fetchext/downloaders/chrome.py`
- `src/fetchext/downloaders/edge.py`
- `src/fetchext/downloaders/firefox.py`
- `tests/unit/test_network.py` (New)

## Verification

- Run `make test`.
