# Plan: YARA Rules Integration (v1.2.0)

## Goal

Integrate `yara-python` to scan extensions against a database of malicious signatures. This allows for identifying known malware patterns within the extension source code.

## Requirements

1. **Dependency**: `yara-python`.
    * *Note*: Since this involves C extensions, we should handle the import gracefully or make it an optional dependency if possible. For now, we will add it to `pyproject.toml` as an optional dependency group `security` or just a standard dependency if wheels are reliable.
    * Decision: Add as optional dependency `fetchext[security]`.
2. **CLI**: Add `--yara <rules_file>` to the `analyze` command.
    * If no rules file is provided, maybe use a bundled default set or warn.
3. **Logic**:
    * Compile YARA rules.
    * Scan files in the extension (extracted or in-memory from ZIP).
    * Report matches.

## Implementation Steps

### 1. Dependency Management

* Update `pyproject.toml` to add `yara-python` to `project.optional-dependencies`.
* Update `requirements-dev.txt` if needed.

### 2. Core Logic (`src/fetchext/analysis/yara.py`)

* Create a class `YaraScanner`.
* Method `scan_file(file_path, rules_path)`.
* Method `scan_content(content, rules_path)`.
* Handle `ImportError` if `yara` is not installed.

### 3. CLI Integration (`src/fetchext/cli.py`)

* Add `--yara` argument to `analyze` parser.
* In the handler, check if `yara` is available. If not, error out suggesting `pip install fetchext[security]`.
* Load rules.
* Iterate through extension files and scan them.
* Print matches using `rich`.

### 4. Testing

* Create `tests/unit/test_yara.py`.
* Mock `yara` module to test logic without requiring the actual library (or use it if available).
* Create a dummy YARA rule for testing.

## Verification

* Run `fext analyze --yara rules.yar extension.crx`.
* Verify output shows matches.
