# Plan: CSP Auditor (v1.3.0)

## Goal

Implement a Content Security Policy (CSP) auditor to analyze extensions for weak security configurations.

## Requirements

1. **Command**: Integrate into `fext audit`.
2. **Analysis**:
    * Parse `content_security_policy` from `manifest.json`.
    * Handle both MV2 (string) and MV3 (object) formats.
    * Detect insecure directives:
        * `unsafe-eval` (Allows code execution from strings).
        * `unsafe-inline` (Allows inline scripts).
        * `http:` / `ftp:` (Insecure schemes).
        * `*` (Wildcard sources).
        * `object-src` not set to 'none' (Flash/Plugins).
3. **Output**: Add findings to the existing audit report structure.

## Implementation Steps

### 1. Core Logic (`src/fetchext/auditor.py`)

* Add `_check_csp(self, manifest: Dict[str, Any], report: AuditReport)` method.
* **MV2 Logic**:
  * CSP is a string (e.g., `"script-src 'self'; object-src 'self'"`).
  * Parse directives and values.
* **MV3 Logic**:
  * CSP is an object: `{"extension_pages": "...", "sandbox": "..."}`.
  * Analyze `extension_pages` policy.
* **Checks**:
  * Regex search for `'unsafe-eval'`, `'unsafe-inline'`.
  * Check for `http://` or `ftp://`.
  * Check for `*` in `script-src`.

### 2. CLI Integration (`src/fetchext/cli.py`)

* No changes needed if we hook into the existing `ExtensionAuditor.audit` method.
* The `audit` command will automatically pick up the new checks.

### 3. Testing

* Create `tests/unit/test_csp_auditor.py`.
* Test cases:
  * MV2 with `unsafe-eval`.
  * MV3 with secure policy.
  * MV3 with insecure `extension_pages` policy.
  * Missing CSP (Default behavior).

## Verification

* Create a dummy extension with a weak CSP.
* Run `fext audit dummy.crx`.
* Verify warnings are displayed.
