# Plan: Local Update Server (v0.8.0)

## Goal

Implement a command to generate update manifests (`update.xml` for Chrome/Edge, `updates.json` for Firefox) for a directory of downloaded extensions. This allows users to host their own extension updates.

## Requirements

1. **Command**: `fext server-manifest <directory> --base-url <url> [--output <file>]`
    * `directory`: Path to the folder containing `.crx` or `.xpi` files.
    * `--base-url`: The base URL where these files will be hosted (e.g., `http://localhost:8000/extensions/`).
    * `--output`: Output file path (default: `update.xml` or `updates.json` based on content).
2. **Logic**:
    * Scan the directory for extension files.
    * Extract ID and Version from each file (using existing `CrxDecoder` or `ZipFile` for XPI).
    * Generate the appropriate manifest format.
        * **Chrome/Edge**: XML format (UpdateManifest v3).
        * **Firefox**: JSON format.
3. **Mixed Content**: If a directory contains both CRX and XPI, maybe generate two files or warn?
    * *Decision*: Generate `update.xml` for CRX files and `updates.json` for XPI files if both exist, or handle based on a flag. For simplicity, let's default to generating `update.xml` for CRX files as the primary use case, and `updates.json` if explicitly requested or if only XPIs are found.
    * *Refined Decision*: The command should probably be specific or smart. Let's make it smart. If it finds CRX, it adds to XML. If it finds XPI, it adds to JSON.
    * Actually, `fext server-manifest` might be ambiguous. Let's stick to the roadmap: "Local Update Server".
    * Let's call the command `fext generate-xml` or `fext update-manifest`.
    * Let's go with `fext update-manifest <directory>`.

## Implementation Details

### 1. New Module: `src/fetchext/server.py`

* Function `generate_update_manifest(directory: Path, base_url: str) -> None`
* Helper `_generate_chrome_xml(extensions, base_url)`
* Helper `_generate_firefox_json(extensions, base_url)`

### 2. CLI Integration (`src/fetchext/cli.py`)

* Add `update-manifest` subcommand.
* Arguments: `directory`, `--base-url` (required), `--output` (optional).

### 3. XML Structure (Chrome)

```xml
<?xml version='1.0' encoding='UTF-8'?>
<gupdate xmlns='http://www.google.com/update2/response' protocol='2.0'>
  <app appid='aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'>
    <updatecheck codebase='http://example.com/extensions/my_extension_v1.0.crx' version='1.0' />
  </app>
</gupdate>
```

### 4. JSON Structure (Firefox)

Firefox self-hosting usually requires the `update_url` in the manifest.json of the XPI to point to this JSON.

```json
{
  "addons": {
    "addon-id@mozilla": {
      "updates": [
        {
          "version": "1.0",
          "update_link": "http://example.com/extensions/addon-1.0.xpi"
        }
      ]
    }
  }
}
```

## Testing Strategy

1. **Unit**: Test XML/JSON generation with mocked extension data.
2. **Integration**: Run against a temp directory with dummy CRX/XPI files.

## Tasks

* [ ] Create `src/fetchext/server.py`.
* [ ] Implement XML generation logic.
* [ ] Implement JSON generation logic.
* [ ] Register command in `cli.py`.
* [ ] Add tests.
