# Plan: CLI Modularization (v1.5.0 Item 1)

## Goal

Refactor the monolithic `src/fetchext/cli.py` into a modular structure using the Command pattern. This will improve maintainability and make it easier to add new commands.

## Current State

`src/fetchext/cli.py` contains:

- Argument parser definition (`get_parser`).
- All subcommand definitions (arguments).
- Dispatch logic in `main()`.
- Imports for all functionalities.

## Proposed Structure

Create a new package `src/fetchext/commands/`.
Each command (or group of related commands) will have its own module.

```text
src/fetchext/commands/
  __init__.py
  base.py       # Abstract base class or protocol for commands
  download.py   # download, batch
  search.py     # search
  inspect.py    # inspect, preview, locales
  audit.py      # audit, risk, scan, secrets, yara
  server.py     # serve, update-manifest, mirror
  utils.py      # extract, convert, optimize
  config.py     # config, setup, clean
  info.py       # stats, history, schema, explain
  visualize.py  # graph, timeline
  tui.py        # ui, tutorial
```

## Implementation Steps

1. **Create Directory**: `mkdir -p src/fetchext/commands`.
2. **Define Interface**: Create `src/fetchext/commands/registry.py` to handle command registration.
    - Instead of a complex class hierarchy, we can use a simple registry pattern where each module exposes a `register_parser(subparsers)` function.
3. **Migrate Commands**: Move logic from `cli.py` to respective modules in `src/fetchext/commands/`.
    - Each module will have a `register(subparsers)` function.
    - Each module will have the handler function (or call the core function).
4. **Refactor `cli.py`**:
    - Import all command modules.
    - Call their `register` functions to build the parser.
    - Simplify `main()` to dispatch based on the selected command.

## Verification

1. [x] Run `make test` to ensure no regressions.
2. [x] Manually run `fext --help` and a few commands (`fext download`, `fext info`) to verify wiring.

## Status

- [x] Create Directory
- [x] Migrate Commands
- [x] Refactor `cli.py`
- [x] Verify
