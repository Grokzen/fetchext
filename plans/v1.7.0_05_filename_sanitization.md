# Plan: Filename Sanitization

## Objective

Ensure downloaded filenames are safe on all OSes (Windows/macOS/Linux) by stripping illegal characters.

## Requirements

1. Sanitize filenames derived from extension names or URLs.
2. Replace illegal characters (e.g., `/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `|`) with safe alternatives (e.g., `_`).
3. Ensure filenames are not too long (max 255 chars).
4. Avoid reserved filenames on Windows (e.g., `CON`, `PRN`, `AUX`, `NUL`).

## Implementation Steps

### 1. Utils (`src/fetchext/utils.py`)

* Add `sanitize_filename(filename: str, replacement: str = "_") -> str` function.
* Use regex to replace illegal characters.
* Truncate to 255 characters.
* Check for reserved names.

### 2. Core (`src/fetchext/core.py`)

* Use `sanitize_filename` when generating filenames for metadata sidecars or extraction directories.
* Currently, `download_extension` uses `output_path.name` which comes from `downloader.download`.
* `downloader.download` usually uses the ID + `.crx` or `.xpi`, which is safe (IDs are alphanumeric).
* However, `extract_extension` uses `output_path.stem` which is also the ID.
* The main issue might be if we ever use the extension *name* for filenames (e.g. "My Extension.crx").
* Wait, `download_extension` saves metadata as `<filename>.json`.
* If the user provides a custom output path, we should probably trust it, but if we generate it, we should sanitize.
* The `downloader.download` method returns a path. Let's check `downloaders/*.py`.

### 3. Downloaders (`src/fetchext/downloaders/*.py`)

* `ChromeDownloader` uses `{extension_id}.crx`. Safe.
* `EdgeDownloader` uses `{extension_id}.crx`. Safe.
* `FirefoxDownloader` uses `{extension_id}.xpi` (or whatever the URL filename is).
  * Firefox URLs can be `.../file/4223423/some_name.xpi`.
  * We should ensure `some_name.xpi` is sanitized.

## Verification

* Unit test: Test `sanitize_filename` with various inputs (illegal chars, long names, reserved names).
* Integration test: Verify Firefox download with complex filename.
