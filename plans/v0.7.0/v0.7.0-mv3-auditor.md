# Plan: v0.7.0 - Manifest V3 Auditor

## Goal

Implement `fext audit <file>` to analyze an extension's compatibility with Manifest V3 (MV3). This tool will report the manifest version and identify potential migration issues.

## Requirements

1. **CLI Command**: `fext audit <file_path>`
2. **Input**: Path to a `.crx`, `.xpi`, or `.zip` file.
3. **Output**: A report detailing:
    - Manifest Version (2 or 3).
    - Presence of deprecated keys in `manifest.json` (e.g., `browser_action`, `page_action`).
    - (Optional) Basic scan of JS files for deprecated API usage (e.g., `chrome.browserAction`).
4. **Performance**: Should use streaming/partial reading where possible, but might need to read full JS files for scanning.

## Implementation Details

### 1. Core Logic (`src/fetchext/auditor.py`)

- Class `ExtensionAuditor`.
- Method `audit_extension(file_path) -> AuditReport`.
- `AuditReport` dataclass:
  - `manifest_version`: int
  - `issues`: List[Issue] (severity, message, file, line)
- **Manifest Checks**:
  - Check `manifest_version`.
  - Check for `browser_action`, `page_action`, `background.scripts` (persistent background pages are deprecated in MV3, replaced by service workers).
  - Check for `content_security_policy` format (object in MV3 vs string in MV2).
- **Code Checks** (Basic Regex):
  - Scan `.js` files for `chrome.browserAction`, `chrome.pageAction`.
  - Scan for `chrome.webRequest` (blocking webRequest is limited in MV3).

### 2. CLI (`src/fetchext/cli.py`)

- Add `audit` subcommand.
- Arguments: `file`, `--json`.
- Output: Use `rich` to print a nice report with warnings/errors.

## Testing Strategy

1. **Unit Tests**:
    - Test `ExtensionAuditor` with mocked manifest data.
    - Test regex patterns for code scanning.
2. **Integration Tests**:
    - Create dummy MV2 and MV3 extensions (zips) and run audit.

## Tasks

- [ ] Create `src/fetchext/auditor.py`.
- [ ] Implement `ExtensionAuditor` class.
- [ ] Add `audit` command to `src/fetchext/cli.py`.
- [ ] Add `audit_extension` to `src/fetchext/core.py`.
- [ ] Add tests.
