# Plan: v0.7.0 - Source Preview

## Goal

Implement `fext preview <file>` to list the contents of a CRX or ZIP file without extracting it to disk. This allows users to inspect the structure of an extension before deciding to extract or install it.

## Requirements

1. **CLI Command**: `fext preview <file_path>`
2. **Input**: Path to a `.crx` or `.zip` file.
3. **Output**: A visual tree structure of the files inside the archive, displayed using `rich`.
4. **Performance**: Should not extract files to disk. Should read the central directory of the ZIP.

## Implementation Details

### 1. Core Logic (`src/fetchext/core.py` or `src/fetchext/utils.py`)

- We need a function `get_archive_structure(file_path: Path) -> List[str]`.
- For `.zip` files, use `zipfile.ZipFile.namelist()`.
- For `.crx` files, we need to handle the CRX header.
  - The existing `CrxDecoder` might need to be exposed or used to get the file pointer to the start of the ZIP data.
  - Once we have the offset, we can open the file, seek to the offset, and pass the file-like object to `zipfile.ZipFile`.

### 2. CLI (`src/fetchext/cli.py`)

- Add `preview` subcommand.
- Arguments: `file` (path to the extension file).
- Use `rich.tree.Tree` to build a visual representation of the file hierarchy.
- Handle errors (file not found, invalid format).

### 3. Display Logic

- Convert the list of paths (e.g., `['manifest.json', 'js/background.js']`) into a nested tree structure for `rich`.

## Testing Strategy

1. **Unit Tests**:
    - Test `get_archive_structure` with a mocked ZIP/CRX file.
    - Verify it returns the correct list of files.
2. **CLI Tests**:
    - Test `fext preview` command invocation.
    - Verify output contains expected file names.
3. **Manual Verification**:
    - Run `fext preview downloads/aicmkgpgakddgnaphhhpliifpcfhicfo.crx` (if available) and check output.

## Tasks

- [ ] Create `src/fetchext/preview.py` (or add to `utils.py`) for the logic.
- [ ] Implement `get_archive_structure`.
- [ ] Implement `build_file_tree` for `rich`.
- [ ] Add `preview` command to `src/fetchext/cli.py`.
- [ ] Add tests in `tests/unit/test_preview.py` and `tests/cli/test_cli.py`.
