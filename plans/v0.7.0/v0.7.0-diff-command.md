# Plan: v0.7.0 - Diff Command

## Goal

Implement `fext diff <old_file> <new_file>` to compare two extension archives. This helps users understand what changed between versions, including file additions/removals and manifest updates.

## Requirements

1. **CLI Command**: `fext diff <old_file> <new_file>`
2. **Input**: Paths to two `.crx`, `.xpi`, or `.zip` files.
3. **Output**: A report detailing:
    - Manifest changes (version, name, permissions).
    - File structure changes (Added, Removed, Modified files).
4. **Performance**: Should use streaming/partial reading to get file lists and manifest. For modified files, we might need to compare CRC32 from zip headers (fast) or content hashes (slow). Zip headers usually have CRC32, so we can use that.

## Implementation Details

### 1. Core Logic (`src/fetchext/diff.py`)

- Class `ExtensionDiffer`.
- Method `diff(old_path, new_path) -> DiffReport`.
- `DiffReport` dataclass:
  - `manifest_changes`: Dict (key -> (old_val, new_val))
  - `added_files`: List[str]
  - `removed_files`: List[str]
  - `modified_files`: List[str]
- **Comparison Logic**:
  - Open both archives.
  - Read manifests and compare JSON.
  - Get file lists with CRC32/Size.
  - Compare sets of filenames.
  - For common files, compare CRC32.

### 2. CLI (`src/fetchext/cli.py`)

- Add `diff` subcommand.
- Arguments: `old_file`, `new_file`, `--json`.
- Output: Use `rich` to print a nice diff report.

## Testing Strategy

1. **Unit Tests**:
    - Test `ExtensionDiffer` with mocked archives.
    - Verify detection of added/removed/modified files.
    - Verify manifest diff.
2. **Integration Tests**:
    - Create two dummy zip files with differences and run diff.

## Tasks

- [ ] Create `src/fetchext/diff.py`.
- [ ] Implement `ExtensionDiffer` class.
- [ ] Add `diff` command to `src/fetchext/cli.py`.
- [ ] Add `diff_extensions` to `src/fetchext/core.py`.
- [ ] Add tests.
