# Plan: Dependency Graph (v1.4.0)

## Goal

Implement `fext graph <file>` to generate a DOT/Graphviz graph of internal file dependencies (imports) within an extension. This helps visualize the structure and complexity of the extension.

## Requirements

1. **New Command**: `fext graph <file>`
2. **Arguments**:
    - `--output`: Output file path (default: `<filename>.dot`).
    - `--format`: Output format (dot, png, svg) - requires `graphviz` installed for png/svg.
3. **Functionality**:
    - Parse JavaScript files to find imports/requires.
    - Support ES6 `import ... from ...`
    - Support CommonJS `require(...)`
    - Build a directed graph of file dependencies.
    - Output in DOT format.
4. **Integration**:
    - Add `analysis/graph.py`.
    - Update `cli.py`.

## Implementation Steps

1. **Create `src/fetchext/analysis/graph.py`**:
    - `build_dependency_graph(file_path: Path) -> Dict[str, List[str]]`:
        - Extract extension to temp dir (or use streaming if possible, but regex on stream is hard).
        - Iterate over all JS files.
        - Use regex to find imports.
        - Resolve relative paths.
        - Return adjacency list.
    - `generate_dot(graph: Dict, title: str) -> str`:
        - Convert adjacency list to DOT format.
2. **Update `src/fetchext/cli.py`**:
    - Add `graph` subcommand.
    - Call `graph.build_dependency_graph` and `graph.generate_dot`.
    - Save to file.
3. **Tests**:
    - Unit test with mock JS content.
    - Integration test with a sample extension.

## Verification

- Run `fext graph ublock-origin.crx`.
- Check generated `.dot` file.
- Visualize with `dot -Tpng -o graph.png graph.dot` (if graphviz installed).
