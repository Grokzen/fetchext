# Plan: Performance Optimization (v1.6.0 Item 3)

## Goal

Optimize `entropy` and `complexity` calculations for large extensions to improve analysis speed.

## Current State

- `analyze_entropy` iterates through all files in the archive sequentially.
- `analyze_complexity` iterates through all JS files sequentially.
- Both operations can be slow for large extensions with many files.

## Proposed Solution

1. **Parallel Processing**: Use `concurrent.futures` to process files in parallel.
2. **Executor Choice**:
    - `complexity`: CPU-bound (parsing). Use `ProcessPoolExecutor` (or `ThreadPoolExecutor` if `lizard` releases GIL, which it might not).
    - `entropy`: CPU-bound (math). Use `ProcessPoolExecutor`.
3. **Implementation Strategy**:
    - Since `ZipFile` cannot be easily shared across processes, we might need to extract to a temp dir first OR re-open zip in workers (inefficient).
    - **Alternative**: Use `ThreadPoolExecutor`. Even with GIL, if we are doing I/O (reading from zip), we get some concurrency. And `lizard` might be pure python.
    - Let's start with `ThreadPoolExecutor` as it's safer for `ZipFile` (though `ZipFile` is not thread safe for concurrent reads, we need a lock or separate handles).
    - Actually, `ZipFile` read is thread-safe in Python 3.11? "zipfile.ZipFile is not thread-safe".
    - So we need a lock around `zf.read()`.

## Revised Strategy

1. **Read-ahead**: Read file contents in the main thread (or a dedicated I/O thread).
2. **Compute in Pool**: Submit the content (bytes/string) to a `ProcessPoolExecutor` for analysis.
3. **Memory Consideration**: Don't read all files into memory at once. Use a bounded semaphore or generator to feed the executor.

## Implementation Details

- Modify `src/fetchext/analysis/entropy.py`.
- Modify `src/fetchext/analysis/complexity.py`.
- Use `concurrent.futures.ProcessPoolExecutor`.
- Limit max workers (default to CPU count).

## Verification

- Create a benchmark test with a large extension (or mock one with many files).
- Compare execution time before and after.
